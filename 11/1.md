
在 autoscale namespace 中创建一个名为 apache-server 的新 HorizonalPodAutoscaler(HPA)
此HAP 必须定位到 autoscale namespace 中的 名为 apache-server 的 Deployment，

将HPA设置为每个Pod的cpu 使用率为50%，最小副本数为1，且不超过4个pod ，此外，将缩小最小稳定窗口设置为30秒


答


我来为您创建一个符合要求的 HorizontalPodAutoscaler (HPA)。以下是详细的步骤和 YAML 配置：

## 方法一：使用 YAML 文件创建

创建文件 `hpa-apache-server.yaml`：

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: apache-server
  namespace: autoscale
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: apache-server
  minReplicas: 1
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 30
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
```

## 方法二：使用 kubectl 命令创建

```bash
# 创建 HPA
kubectl autoscale deployment apache-server -n autoscale \
  --cpu-percent=50 \
  --min=1 \
  --max=4

# 然后通过 patch 命令添加缩放行为配置
kubectl patch hpa apache-server -n autoscale --type='merge' -p '{
  "spec": {
    "behavior": {
      "scaleDown": {
        "stabilizationWindowSeconds": 30,
        "policies": [
          {
            "type": "Percent",
            "value": 100,
            "periodSeconds": 15
          }
        ]
      }
    }
  }
}'
```

## 验证 HPA 创建

```bash
# 检查 HPA 状态
kubectl get hpa apache-server -n autoscale

# 查看 HPA 详细信息
kubectl describe hpa apache-server -n autoscale
```

## 关键配置说明

- **scaleTargetRef**: 指向 `autoscale` namespace 中的 `apache-server` Deployment
- **minReplicas**: 最小副本数 = 1
- **maxReplicas**: 最大副本数 = 4  
- **metrics**: CPU 使用率目标 = 50%
- **behavior.scaleDown.stabilizationWindowSeconds**: 缩小最小稳定窗口 = 30 秒

## 注意事项

1. **确保 Deployment 存在**: 在创建 HPA 前，请确认 `apache-server` Deployment 已在 `autoscale` namespace 中运行
2. **资源请求设置**: Deployment 中的 Pod 需要设置 CPU 资源请求，HPA 才能正确计算 CPU 使用率
3. **Metrics Server**: 集群需要安装 metrics-server 才能提供资源使用率数据

这样创建的 HPA 就会根据 CPU 使用率自动缩放 `apache-server` Deployment 的副本数，并在缩小时保持 30 秒的稳定窗口。
