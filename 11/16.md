
Task

名为nginx-static 的NGINX Deployment正在Deployment 正在namespace nginx-static 中运行,他通过名为 nginx-config 的configmap 进行配置。

首先 更新 configmap nginx-config 以允许 TLSv1.2 连接
> 将指令 ssl_protocols 设置为 ssl_protocls TLSv1.2 TLSv1.31以允许TLS1.2。

> 你可以根据需要重新创建，重新启动或扩展资源

你可以使用以下命令测试更改

curl --tls-max 1.2 https://web.k8s.local

> 由于应该允许 TLS1.2 此命令应该成功

最后将configmap nginx-config 设置为不可变



我将帮您更新 nginx-config ConfigMap 以允许 TLSv1.2 连接，并将其设置为不可变。以下是完整的步骤：

## 步骤 1：检查当前 ConfigMap 配置

首先，查看当前的 nginx-config ConfigMap：

```bash
kubectl get configmap nginx-config -n nginx-static -o yaml
```

## 步骤 2：更新 ConfigMap 以允许 TLSv1.2

根据您的需求，我们需要更新 nginx 配置，添加 `ssl_protocols TLSv1.2 TLSv1.3;` 指令。

### 方法一：使用 kubectl edit（交互式编辑）

```bash
kubectl edit configmap nginx-config -n nginx-static
```

在编辑器中，找到 nginx 配置部分，添加或修改 `ssl_protocols` 指令：

```nginx
server {
    listen 443 ssl;
    server_name web.k8s.local;
    
    # 添加 TLS 协议配置
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 其他现有配置...
    ssl_certificate /etc/nginx/ssl/tls.crt;
    ssl_certificate_key /etc/nginx/ssl/tls.key;
    
    # 其他配置...
}
```

### 方法二：使用 kubectl patch 或替换整个 ConfigMap

如果知道当前配置的确切结构，可以创建新的 ConfigMap YAML 文件：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: nginx-static
data:
  nginx.conf: |
    server {
        listen 443 ssl;
        server_name web.k8s.local;
        
        # 添加 TLS 协议配置
        ssl_protocols TLSv1.2 TLSv1.3;
        
        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;
        
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
```

然后应用更新：

```bash
kubectl apply -f nginx-config-updated.yaml
```

## 步骤 3：重启 Deployment 以应用配置更改

由于 ConfigMap 更新后，运行的 Pod 不会自动获取新配置，需要重启 Deployment：

```bash
# 重启 Deployment 以应用新配置
kubectl rollout restart deployment/nginx-static -n nginx-static

# 等待重启完成
kubectl rollout status deployment/nginx-static -n nginx-static
```

## 步骤 4：测试 TLSv1.2 连接

```bash
# 测试 TLSv1.2 连接（应该成功）
curl --tls-max 1.2 -k https://web.k8s.local

# 也可以测试 TLSv1.3 连接
curl --tls-max 1.3 -k https://web.k8s.local

# 详细测试，查看 TLS 握手信息
curl -v --tls-max 1.2 -k https://web.k8s.local 2>&1 | grep -i "SSL\|TLS"
```

## 步骤 5：将 ConfigMap 设置为不可变

一旦确认配置正确，将 ConfigMap 设置为不可变：

```bash
# 将 ConfigMap 设置为不可变
kubectl patch configmap nginx-config -n nginx-static -p '{"immutable": true}'
```

或者，在 YAML 文件中直接设置：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: nginx-static
immutable: true  # 设置为不可变
data:
  nginx.conf: |
    # 您的 nginx 配置内容...
```

## 完整的工作流程脚本

以下是完整的自动化脚本：

```bash
#!/bin/bash

echo "=== 更新 nginx-config ConfigMap 以支持 TLSv1.2 ==="

# 备份当前 ConfigMap
echo "备份当前 ConfigMap..."
kubectl get configmap nginx-config -n nginx-static -o yaml > nginx-config-backup.yaml

# 更新 ConfigMap
echo "更新 ConfigMap..."
kubectl get configmap nginx-config -n nginx-static -o yaml | \
  sed '/^data:/a\    nginx.conf: |' | \
  sed '/nginx.conf: |/a\      server {\n        listen 443 ssl;\n        server_name web.k8s.local;\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_certificate /etc/nginx/ssl/tls.crt;\n        ssl_certificate_key /etc/nginx/ssl/tls.key;\n        location / {\n            root /usr/share/nginx/html;\n            index index.html;\n        }\n      }' | \
  kubectl apply -f -

# 重启 Deployment
echo "重启 nginx-static Deployment..."
kubectl rollout restart deployment/nginx-static -n nginx-static

# 等待重启完成
echo "等待重启完成..."
kubectl rollout status deployment/nginx-static -n nginx-static --timeout=60s

# 测试 TLSv1.2 连接
echo "测试 TLSv1.2 连接..."
if curl --tls-max 1.2 -k -s -o /dev/null -w "%{http_code}" https://web.k8s.local; then
    echo " - TLSv1.2 连接测试成功"
else
    echo " - TLSv1.2 连接测试失败"
fi

# 设置 ConfigMap 为不可变
echo "设置 ConfigMap 为不可变..."
kubectl patch configmap nginx-config -n nginx-static -p '{"immutable": true}'

echo "=== 完成 ==="
```

## 验证配置

完成所有步骤后，进行最终验证：

```bash
# 检查 ConfigMap 是否设置为不可变
kubectl get configmap nginx-config -n nginx-static -o yaml | grep immutable

# 再次测试 TLSv1.2 连接
curl --tls-max 1.2 -k -I https://web.k8s.local

# 检查 Pod 日志确认无错误
kubectl logs -n nginx-static -l app=nginx-static
```

## 重要说明

1. **TLS 协议配置**: `ssl_protocols TLSv1.2 TLSv1.3;` 明确允许 TLSv1.2 和 TLSv1.3 连接
2. **不可变 ConfigMap**: 一旦设置为不可变，将无法修改，除非删除后重新创建
3. **Deployment 重启**: ConfigMap 更新后必须重启 Pod 才能生效
4. **测试验证**: 使用 `--tls-max 1.2` 参数确保 curl 使用 TLSv1.2

完成这些步骤后，nginx-static Deployment 将允许 TLSv1.2 连接，并且 ConfigMap 将被设置为不可变以防止意外更改。