
Context



集群的CNI未通过安全审核，已被移除。你必须安装一个可以实施新的网络策略的CNI。

Task

安装并设置满足一下要求的容器网络接口 CNI

选择并安装以下CNI 选项之一 

* Flannel版本 0.26.1
    Manifest URL: xxxx
* Calico版本 3.28.2
    Manifest;xxx

选择的CNI必须 
* 让pod之间相互通信
* 支持Network policy 实施
* 从清单文件安装 （请勿用Helm安装）





为集群选择和安装一个合适的CNI插件确实很重要。根据你的要求，在 Flannel 和 Calico 之间，**我更推荐你安装 Calico**，因为它能更好地满足你对网络策略（Network Policy）实施的需求。

下面我为你整理了这两个CNI的对比和具体的安装步骤。

### CNI 插件选择对比

| 特性 | Flannel | Calico |
| :--- | :--- | :--- |
| **网络策略支持** | 原生**不支持**，需额外集成组件 | **原生支持** |
| **安装复杂度** | 简单 | 简单 |
| **推荐程度** | ⭐⭐ | ⭐⭐⭐⭐ |

**推荐理由**：你的任务明确要求CNI必须支持Network Policy实施。Calico**原生支持**Kubernetes的NetworkPolicy资源，可以直接通过YAML清单文件定义和实施复杂的网络策略。而Flannel本身是一个简单的Overlay网络方案，其设计初衷并不包含网络策略功能。虽然可以通过集成`kube-network-policies`项目来增加支持，但这会引入额外的复杂性和维护成本。

### 如何安装 Calico

安装Calico较为直接，你可以通过以下步骤完成。

1.  **应用清单文件**
    使用`kubectl`命令直接安装指定版本的Calico。这将创建所有必要的Pod、服务账户和配置。
    ```bash
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.2/manifests/calico.yaml
    ```
    *如果因网络问题无法直接拉取，可以先将`calico.yaml`文件下载到本地，再通过`kubectl apply -f calico.yaml`安装。*

2.  **等待安装完成**
    安装命令执行后，Calico的Pod会在`kube-system`命名空间下启动。你可以使用以下命令查看Pod的状态，等待所有Pod都进入`Running`状态。
    ```bash
    kubectl get pods -n kube-system -w
    ```

### 验证安装与基础功能

安装完成后，你可以通过以下方式验证Calico是否正常工作并满足要求：

-   **检查Pod状态**：确保所有Calico相关的Pod（如`calico-node-xxxxx`，`calico-kube-controllers-xxxxx`）都处于`Running`状态。
    ```bash
    kubectl get pods -n kube-system | grep calico
    ```

-   **验证Pod间通信**：
    1.  创建一个简单的测试Deployment（例如，使用Nginx镜像）。
    2.  将其扩展为多个副本。
    3.  进入一个Pod，尝试`ping`或其他Pod的IP地址，确认网络是连通的。这满足了"让Pod之间相互通信"的要求。

-   **验证网络策略支持**：
    1.  你可以尝试创建一个简单的NetworkPolicy来测试。例如，创建一个"默认拒绝所有入站流量"的策略：
        ```yaml
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: default-deny-ingress
          namespace: default
        spec:
          podSelector: {}  # 匹配所有Pod
          policyTypes:
          - Ingress  # 仅控制入站流量
        ```
    2.  应用此策略后，未被其他策略明确允许的入站连接将被拒绝，这证明网络策略已生效。

希望这些详细的步骤能帮助你顺利完成Calico的安装和配置。如果你在安装过程中遇到任何问题，或者想了解如何编写具体的网络策略，随时可以再来问我。


