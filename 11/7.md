Task


首先 为名为 rancher.io/local-path 的现有制备器创建一个名为 local-path 的新 StorageClass . 将卷绑定模式设置为 WaitForFirstConsumer ,

接下来，将local-path StorageClass 配置为默认的StorageClass .






我将帮您创建一个新的 StorageClass 并将其设置为默认 StorageClass。以下是完整的步骤：

## 步骤 1：创建 local-path StorageClass

创建文件 `local-path-storageclass.yaml`：

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-path
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: rancher.io/local-path
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: false
```

应用这个 StorageClass：

```bash
kubectl apply -f local-path-storageclass.yaml
```

## 步骤 2：将 local-path 设置为默认 StorageClass

首先，检查当前是否有默认的 StorageClass：

```bash
kubectl get storageclass
```

如果有其他默认的 StorageClass，需要先取消它的默认设置：

```bash
# 取消现有的默认 StorageClass（如果有的话）
kubectl patch storageclass <existing-default-storageclass-name> -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'
```

然后将 local-path 设置为默认：

```bash
# 将 local-path 设置为默认 StorageClass
kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
```

## 步骤 3：验证配置

```bash
# 检查 StorageClass 列表，local-path 应该显示为 (default)
kubectl get storageclass

# 查看 local-path StorageClass 的详细信息
kubectl describe storageclass local-path
```

## 完整的 YAML 文件（一步到位）

如果您想一步完成创建和设置为默认，可以使用以下完整的 YAML：

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-path
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: rancher.io/local-path
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: false
reclaimPolicy: Delete
```

然后直接应用：

```bash
kubectl apply -f local-path-storageclass.yaml
```

## 关键配置说明

- **provisioner**: `rancher.io/local-path` - 使用现有的本地路径制备器
- **volumeBindingMode**: `WaitForFirstConsumer` - 延迟卷绑定，直到 Pod 被调度
- **is-default-class**: `"true"` - 标记为默认 StorageClass
- **allowVolumeExpansion**: `false` - 不允许卷扩展（本地存储通常不支持）
- **reclaimPolicy**: `Delete` - Pod 删除后自动删除 PV（默认值）

## 验证 PVC 创建

测试新的默认 StorageClass 是否正常工作：

```bash
# 创建一个测试 PVC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
EOF

# 检查 PVC 状态
kubectl get pvc test-pvc

# 清理测试 PVC
kubectl delete pvc test-pvc
```

完成这些步骤后，您的集群将使用 `local-path` 作为默认 StorageClass，并且所有新的 PVC（如果没有指定 StorageClass）都会使用这个制备器，采用 `WaitForFirstConsumer` 绑定模式。