

Task

将现有的Web应用从Ingress迁移到GeteWay API .你必须维护HTTPS 访问权限
> 集群中安装了一个名为 nginx 的 GatewayClass 

首先， 创建出一个名为 web-gateway 的 Gateway 对象，主机名为 gateway.web.k8s.local 并保持现有名为web 的 Ingress 资源的现有的TLS和侦听器配置。

接下来创建一个名为 web-route 的HTTPRoute，主机名为  gateway.web.k8s.local 并保持现有名为 web的 ingress 资源的现有的路由配置。   

> 你可以使用以下命令测试 Gateway API 配置 curl https://gateway.web.k8s.local/ 
最后，删除名为 web 的 Ingress 资源，



我将帮您将现有的 Web 应用从 Ingress 迁移到 Gateway API，同时保持 HTTPS 访问权限。以下是完整的步骤：

## 步骤 1：检查现有 Ingress 配置

首先，我们需要查看现有的 Ingress 资源配置：

```bash
kubectl get ingress web -o yaml
```

这将帮助我们了解当前的 TLS 配置、主机名和后端服务信息。

## 步骤 2：创建 Gateway 对象

创建文件 `web-gateway.yaml`：

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: web-gateway
spec:
  gatewayClassName: nginx
  listeners:
  - name: https
    port: 443
    protocol: HTTPS
    hostname: "gateway.web.k8s.local"
    tls:
      mode: Terminate
      certificateRefs:
      - name: web-tls-certificate  # 假设使用与现有 Ingress 相同的证书 Secret
    allowedRoutes:
      namespaces:
        from: Same
```

应用 Gateway：

```bash
kubectl apply -f web-gateway.yaml
```

## 步骤 3：创建 HTTPRoute 对象

创建文件 `web-route.yaml`：

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: web-route
spec:
  parentRefs:
  - name: web-gateway
    namespace: default  # 如果 Gateway 在相同命名空间
  hostnames:
  - "gateway.web.k8s.local"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: web-service  # 替换为实际的后端服务名称
      port: 80
```

应用 HTTPRoute：

```bash
kubectl apply -f web-route.yaml
```

## 步骤 4：处理 TLS 证书

如果现有 Ingress 使用了 TLS，我们需要确保证书可用。假设现有 Ingress 使用了名为 `web-tls` 的 Secret：

```bash
# 检查现有的 TLS Secret
kubectl get secret web-tls -o yaml

# 如果 Gateway 需要不同的证书引用名称，可能需要创建新的 Secret
# 或者直接使用现有的 Secret（如果名称匹配）
```

如果证书名称不匹配，您可能需要更新 Gateway 配置中的 `certificateRefs` 部分。

## 步骤 5：验证 Gateway API 配置

```bash
# 检查 Gateway 状态
kubectl get gateway web-gateway

# 查看 Gateway 详细信息
kubectl describe gateway web-gateway

# 检查 HTTPRoute 状态
kubectl get httproute web-route

# 查看 HTTPRoute 详细信息
kubectl describe httproute web-route
```

## 步骤 6：测试配置

```bash
# 测试 Gateway API 配置
curl -k https://gateway.web.k8s.local/

# 或者使用更详细的测试
curl -v -k -H "Host: gateway.web.k8s.local" https://gateway.web.k8s.local/
```

## 步骤 7：删除原有 Ingress 资源

确认新的 Gateway API 配置正常工作后，删除原有的 Ingress：

```bash
kubectl delete ingress web
```

## 完整的工作流程

以下是完整的脚本，执行所有必要步骤：

```bash
#!/bin/bash

# 步骤 1: 检查现有 Ingress 配置
echo "=== 检查现有 Ingress 配置 ==="
kubectl get ingress web -o yaml | grep -A 10 -B 5 "tls\|host\|service"

# 步骤 2: 创建 Gateway
echo "=== 创建 Gateway ==="
cat <<EOF | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: web-gateway
spec:
  gatewayClassName: nginx
  listeners:
  - name: https
    port: 443
    protocol: HTTPS
    hostname: "gateway.web.k8s.local"
    tls:
      mode: Terminate
      certificateRefs:
      - name: web-tls
    allowedRoutes:
      namespaces:
        from: Same
EOF

# 步骤 3: 创建 HTTPRoute
echo "=== 创建 HTTPRoute ==="
cat <<EOF | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: web-route
spec:
  parentRefs:
  - name: web-gateway
  hostnames:
  - "gateway.web.k8s.local"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: web-service
      port: 80
EOF

# 步骤 4: 等待配置生效
echo "=== 等待配置生效 ==="
sleep 10

# 步骤 5: 验证配置
echo "=== 验证 Gateway 配置 ==="
kubectl get gateway web-gateway -o wide
kubectl get httproute web-route -o wide

# 步骤 6: 测试连接
echo "=== 测试 Gateway API 配置 ==="
curl -k -s -o /dev/null -w "%{http_code}" https://gateway.web.k8s.local/ && echo " - HTTP Status"

# 步骤 7: 删除原有 Ingress (如果测试成功)
echo "=== 删除原有 Ingress 资源 ==="
kubectl delete ingress web

echo "=== 迁移完成 ==="
```

## 重要说明

1. **TLS 配置**: 确保 TLS 证书 Secret 存在且正确配置
2. **服务名称**: 将 `web-service` 替换为实际的后端服务名称
3. **命名空间**: 如果资源不在默认命名空间，请相应调整
4. **GatewayClass**: 使用集群中已安装的 `nginx` GatewayClass
5. **测试**: 在删除原有 Ingress 前，务必测试新配置是否正常工作

完成这些步骤后，您的 Web 应用将从 Ingress 成功迁移到 Gateway API，同时保持 HTTPS 访问权限。