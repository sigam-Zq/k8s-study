


Context 

你需要将一个传统的应用程序集成到k8s 的日志架构 例如 kubectl logs 命令 中 实现这个要求的方法一般是添加一个流式传输并置容器

Task

更新现有的synergy-leverager Deployment ,并使用 busybox:stable 镜像作为 sidecar 并置容器 添加到现有的pod 中 ，新的并置容器 必须运行一下命令

```
/bin/sh -c "tail -n+1 -f /var/log/synergy-leverager.log"
```

使用挂载在 /var/log 的Volume 使日志文件synergy-leverager.log可供并置容器使用







我来帮您更新 synergy-leverager Deployment，添加一个 busybox sidecar 容器来流式传输日志文件。

## 步骤 1：检查当前 Deployment 配置

```bash
# 首先查看当前的 Deployment 配置
kubectl get deployment synergy-leverager -o yaml
```

## 步骤 2：创建更新后的 Deployment YAML

创建文件 `synergy-leverager-updated.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synergy-leverager
  # 如果有 namespace，请添加
  # namespace: your-namespace
spec:
  selector:
    matchLabels:
      app: synergy-leverager
  template:
    metadata:
      labels:
        app: synergy-leverager
    spec:
      containers:
      # 原有的主容器
      - name: synergy-leverager
        image: your-existing-image  # 保持原有镜像
        # 保持原有的所有配置
        volumeMounts:
        - name: log-volume
          mountPath: /var/log
        # 其他原有配置...
      
      # 新增的 sidecar 容器
      - name: log-tailer
        image: busybox:stable
        command: ["/bin/sh", "-c", "tail -n+1 -f /var/log/synergy-leverager.log"]
        volumeMounts:
        - name: log-volume
          mountPath: /var/log
      
      # 定义 Volume
      volumes:
      - name: log-volume
        emptyDir: {}  # 或者使用合适的 Volume 类型
```

## 步骤 3：应用更新

```bash
# 应用更新后的配置
kubectl apply -f synergy-leverager-updated.yaml

# 或者使用 patch 命令（更复杂，但可以避免重新定义整个 Deployment）
```

## 方法二：使用 kubectl patch 命令

如果不想创建完整的 YAML 文件，可以使用 patch 命令：

```bash
# 添加 sidecar 容器
kubectl patch deployment synergy-leverager -p '{
  "spec": {
    "template": {
      "spec": {
        "containers": [
          {
            "name": "log-tailer",
            "image": "busybox:stable",
            "command": ["/bin/sh", "-c", "tail -n+1 -f /var/log/synergy-leverager.log"],
            "volumeMounts": [
              {
                "name": "log-volume",
                "mountPath": "/var/log"
              }
            ]
          }
        ],
        "volumes": [
          {
            "name": "log-volume",
            "emptyDir": {}
          }
        ]
      }
    }
  }
}'
```

## 步骤 4：验证配置

```bash
# 检查 Pod 状态
kubectl get pods -l app=synergy-leverager

# 查看 Pod 详细信息，确认 sidecar 容器已添加
kubectl describe pod <pod-name>

# 测试 sidecar 容器的日志输出
kubectl logs <pod-name> -c log-tailer

# 也可以查看主容器的日志
kubectl logs <pod-name> -c synergy-leverager
```

## 完整示例（包含主容器配置）

如果您需要完整的 Deployment 配置示例：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synergy-leverager
  labels:
    app: synergy-leverager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: synergy-leverager
  template:
    metadata:
      labels:
        app: synergy-leverager
    spec:
      containers:
      # 主应用程序容器
      - name: synergy-leverager
        image: your-app-image:latest
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: log-volume
          mountPath: /var/log
        env:
        - name: LOG_FILE
          value: "/var/log/synergy-leverager.log"
        # 其他原有配置...
      
      # Sidecar 日志容器
      - name: log-tailer
        image: busybox:stable
        command: ["/bin/sh", "-c", "tail -n+1 -f /var/log/synergy-leverager.log"]
        volumeMounts:
        - name: log-volume
          mountPath: /var/log
      
      volumes:
      - name: log-volume
        emptyDir: {}
```

## 重要说明

1. **Volume 类型**: 我使用了 `emptyDir: {}`，这是一个临时卷，Pod 删除后数据会丢失。如果您需要持久化日志，请使用合适的 Volume 类型（如 `hostPath`、`persistentVolumeClaim` 等）。

2. **日志文件位置**: 确保主应用程序确实将日志写入 `/var/log/synergy-leverager.log`

3. **访问日志**: 现在您可以通过以下命令访问日志：
   ```bash
   # 查看 sidecar 容器日志
   kubectl logs <pod-name> -c log-tailer
   
   # 查看主容器日志
   kubectl logs <pod-name> -c synergy-leverager
   ```

4. **滚动更新**: 这个更改会触发 Deployment 的滚动更新，重新创建 Pod。

完成这些步骤后，您的应用程序日志就可以通过 `kubectl logs` 命令访问了，sidecar 容器会持续流式传输日志文件内容。