

Task

mariadb namespace 中的MariaDB Deployment 被误删除 。请恢复该 Deployment 并确保数据持久性，请按照以下步骤.

步骤
    如下规格在 mariadb namespace 中创建名为 mariadb的 PersistentVolumeClaim(PVC)
    访问模式。ReadWriteOnec
    存储。256Mi

     > 你必须使用被保留的PersistentVolume(PV) 不选择会导致分数降低


编辑位于 /home/ca/mariadb-deployment.yaml 的 Deployment 配置文件,以使用上一步中的创建PVC,将更新的deployment 文件应用到集群




我将帮您恢复 MariaDB Deployment 并确保数据持久性。以下是完整的步骤：

## 步骤 1：创建 PersistentVolumeClaim (PVC)

首先创建 PVC 文件 `mariadb-pvc.yaml`：

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb
  namespace: mariadb
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
  # 不指定 storageClassName 以使用默认的或匹配现有 PV
```

应用 PVC：

```bash
kubectl apply -f mariadb-pvc.yaml
```

## 步骤 2：检查 PVC 状态

```bash
# 验证 PVC 已创建并绑定到保留的 PV
kubectl get pvc -n mariadb

# 查看 PVC 详细信息
kubectl describe pvc mariadb -n mariadb
```

## 步骤 3：编辑 Deployment 配置文件

编辑 `/home/ca/mariadb-deployment.yaml` 文件，添加 PVC 配置。您需要在以下位置添加 volume 和 volumeMount：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
  namespace: mariadb
spec:
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:latest
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: password
        ports:
        - containerPort: 3306
        # 添加 volumeMount
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
      # 添加 volumes 部分
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: mariadb
```

如果您需要保留原始文件中的其他配置，请确保只添加上述的 `volumeMounts` 和 `volumes` 部分。

## 步骤 4：应用更新后的 Deployment

```bash
# 应用更新后的 Deployment
kubectl apply -f /home/ca/mariadb-deployment.yaml

# 或者如果文件已经存在，可以先删除再创建
kubectl delete -f /home/ca/mariadb-deployment.yaml 2>/dev/null || true
kubectl apply -f /home/ca/mariadb-deployment.yaml
```

## 步骤 5：验证恢复

```bash
# 检查 Deployment 状态
kubectl get deployment mariadb -n mariadb

# 检查 Pod 状态
kubectl get pods -n mariadb -l app=mariadb

# 查看 Pod 日志确保正常启动
kubectl logs -n mariadb -l app=mariadb

# 验证 PVC 已正确挂载
kubectl describe pod -n mariadb -l app=mariadb | grep -A 10 -B 5 "Mounts"
```

## 完整的工作流程脚本

如果您想一次性执行所有步骤，可以使用以下脚本：

```bash
#!/bin/bash

# 步骤 1: 创建 PVC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb
  namespace: mariadb
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
EOF

# 步骤 2: 等待 PVC 绑定
echo "等待 PVC 绑定..."
kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/mariadb -n mariadb --timeout=60s

# 步骤 3: 应用 Deployment
kubectl apply -f /home/ca/mariadb-deployment.yaml

# 步骤 4: 验证
echo "检查部署状态..."
kubectl rollout status deployment/mariadb -n mariadb --timeout=180s

# 最终状态检查
echo "最终状态:"
kubectl get deployment,pvc,pod -n mariadb
```

## 重要说明

1. **使用保留的 PV**: 通过创建匹配的 PVC，Kubernetes 会自动将其绑定到可用的 PV（包括之前保留的 PV）

2. **数据持久性**: PVC 确保数据在 Pod 重启或重新调度时得以保留

3. **访问模式**: `ReadWriteOnce` 允许单个节点以读写模式挂载卷

4. **存储大小**: 256Mi 应该足够 MariaDB 的基本运行

完成这些步骤后，MariaDB Deployment 将被恢复，并且能够访问之前保留的持久化数据（如果 PV 中确实存在的话）。