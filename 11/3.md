
Context

ä½ çš„ä»»åŠ¡æ˜¯ä¸ºk8s å‡†å¤‡ä¸€ä¸ªliunxç³»ç»Ÿ docker å·²ç»è¢«å®‰è£… ä½†æ˜¯ä½ éœ€è¦ä¸ºkubeadm é…ç½®å®ƒ

Task 
å®Œæˆä»¥ä¸‹ä»»åŠ¡ ä¸ºk8s å‡†å¤‡ç³»ç»Ÿ 

è®¾ç½® cri-dockerd: 

1. è®¾ç½® cri-dockerd

    å®‰è£… /home/ca/cri-dockerd.dep

    qemu-user-static

    å¯ç”¨å¹¶å¯åŠ¨cri-docker    æœåŠ¡



    é…ç½®ä»¥ä¸‹ç³»ç»Ÿå‚æ•°

    net.bridge.bridge-nf-call-iptables=1
    net.ipv6.conf.all.forwarding=1
    net.ipv4.ip_forward=1
    net.netfilter.nf_conntrack_max=131072

 

 è¦ä¸ºKuberneteså‡†å¤‡Linuxç³»ç»Ÿå¹¶é…ç½®å¥½Dockerå’Œcri-dockerdï¼Œä½ éœ€è¦å®Œæˆä¸€ç³»åˆ—æ­¥éª¤ã€‚æˆ‘å·²ç»ä¸ºä½ æ•´ç†äº†ä»å®‰è£…cri-dockerdã€é…ç½®ç³»ç»Ÿå‚æ•°åˆ°éªŒè¯é…ç½®çš„å®Œæ•´æµç¨‹ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

### ğŸ”§ å®‰è£…ä¸é…ç½® cri-dockerd

ç”±äºKubernetesè‡ª1.24ç‰ˆæœ¬èµ·ç§»é™¤äº†å¯¹Dockerçš„ç›´æ¥æ”¯æŒï¼ˆå³Dockershimï¼‰ï¼Œä½ éœ€è¦ä½¿ç”¨cri-dockerdä½œä¸ºDockerçš„CRIæ¥å£ã€‚

1.  **å®‰è£…cri-dockerd**ï¼š
    å‡è®¾å®‰è£…åŒ…å·²å°±ä½ï¼Œç›´æ¥ä½¿ç”¨dpkgå‘½ä»¤å®‰è£…ã€‚
    ```bash
    sudo dpkg -i /home/ca/cri-dockerd.deb
    ```
    å¦‚æœé‡åˆ°ä¾èµ–é—®é¢˜ï¼Œè¿è¡Œ `sudo apt-get install -f` æ¥è§£å†³ã€‚

2.  **å®‰è£… `qemu-user-static`**ï¼š
    è¿™ä¸ªåŒ…é€šå¸¸ç”¨äºè·¨æ¶æ„è¿è¡Œå®¹å™¨ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯å¿…é¡»çš„ã€‚
    ```bash
    sudo apt-get update
    sudo apt-get install -y qemu-user-static
    ```

3.  **å¯ç”¨å¹¶å¯åŠ¨cri-dockeræœåŠ¡**ï¼š
    å®‰è£…åï¼Œä½ éœ€è¦è®¾ç½®æœåŠ¡å¼€æœºè‡ªå¯å¹¶ç«‹å³å¯åŠ¨å®ƒã€‚
    ```bash
    sudo systemctl enable cri-docker.service
    sudo systemctl start cri-docker.service
    ```
    å¯åŠ¨åï¼Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹æœåŠ¡çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼š
    ```bash
    sudo systemctl status cri-docker.service
    ```
    å¦‚æœçŠ¶æ€ä¸º `active (running)`ï¼Œè¯´æ˜æœåŠ¡å·²æˆåŠŸå¯åŠ¨ã€‚

### âš™ï¸ é…ç½®ç³»ç»Ÿå†…æ ¸å‚æ•°

æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦é…ç½®ä¸€äº›å…³é”®çš„å†…æ ¸å‚æ•°ä»¥ç¡®ä¿Kubernetesç½‘ç»œå’Œè¿æ¥è¿½è¸ªèƒ½æ­£å¸¸å·¥ä½œã€‚

1.  **ç¼–è¾‘sysctlé…ç½®æ–‡ä»¶**ï¼š
    ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚nanoæˆ–vimï¼‰æ‰“å¼€ `/etc/sysctl.conf` æ–‡ä»¶ã€‚
    ```bash
    sudo nano /etc/sysctl.conf
    ```

2.  **æ·»åŠ æˆ–ä¿®æ”¹å‚æ•°**ï¼š
    åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æˆ–ç¡®ä¿ä»¥ä¸‹è¡Œå­˜åœ¨ï¼š
    ```ini
    net.bridge.bridge-nf-call-iptables = 1
    net.ipv6.conf.all.forwarding = 1
    net.ipv4.ip_forward = 1
    net.netfilter.nf_conntrack_max = 131072
    ```
    **å‚æ•°è¯´æ˜**ï¼š
    *   `net.bridge.bridge-nf-call-iptables=1`ï¼šç¡®ä¿ç½‘æ¡¥ä¸Šçš„æµé‡ç»è¿‡iptablesï¼Œè¿™å¯¹äºKubernetesæœåŠ¡ç½‘ç»œè‡³å…³é‡è¦ã€‚
    *   `net.ipv4.ip_forward=1` ä¸ `net.ipv6.conf.all.forwarding=1`ï¼šå¯ç”¨IPv4å’ŒIPv6çš„åŒ…è½¬å‘ï¼Œè¿™æ˜¯Podé—´é€šä¿¡çš„åŸºç¡€ã€‚
    *   `net.netfilter.nf_conntrack_max=131072`ï¼šå¢å¤§è¿æ¥è·Ÿè¸ªè¡¨çš„æœ€å¤§å€¼ï¼Œæœ‰åŠ©äºé¿å…åœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹å‡ºç°"table full"é—®é¢˜ã€‚

3.  **ä½¿é…ç½®ç”Ÿæ•ˆ**ï¼š
    æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è®©é…ç½®ç«‹å³ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰ã€‚
    ```bash
    sudo sysctl -p
    ```

### ğŸ” éªŒè¯é…ç½®

å®Œæˆæ‰€æœ‰é…ç½®åï¼Œå»ºè®®è¿›è¡ŒéªŒè¯ä»¥ç¡®ä¿ä¸€åˆ‡è®¾ç½®æ­£ç¡®ã€‚

1.  **éªŒè¯cri-dockerdæœåŠ¡**ï¼š
    å†æ¬¡ç¡®è®¤cri-dockerdæœåŠ¡å¤„äºæ´»è·ƒçŠ¶æ€ã€‚
    ```bash
    sudo systemctl is-active cri-docker.service
    ```
    é¢„æœŸè¾“å‡ºåº”ä¸º `active`ã€‚

2.  **éªŒè¯å†…æ ¸å‚æ•°**ï¼š
    é€šè¿‡sysctlæ£€æŸ¥å…³é”®å‚æ•°æ˜¯å¦å·²æŒ‰é¢„æœŸè®¾ç½®ã€‚
    ```bash
    sudo sysctl net.bridge.bridge-nf-call-iptables net.ipv4.ip_forward net.netfilter.nf_conntrack_max
    ```
    ç¡®è®¤è¾“å‡ºçš„å€¼ä¸ä½ è®¾ç½®çš„ç›¸ç¬¦ã€‚

å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤åï¼Œä½ çš„Linuxç³»ç»Ÿå°±å·²ç»ä¸ºä½¿ç”¨kubeadméƒ¨ç½²Kubernetesåšå¥½äº†å‡†å¤‡ã€‚

å¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œæˆ–è€…æƒ³äº†è§£Kubernetesç»„ä»¶çš„è¿›ä¸€æ­¥é…ç½®ï¼Œéšæ—¶å¯ä»¥å†æ¥é—®æˆ‘ã€‚