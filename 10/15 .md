Solve this question on: ssh cka7968

 

There was a security incident where an intruder was able to access the whole cluster from a single hacked backend Pod.

To prevent this create a NetworkPolicy called np-backend in Namespace project-snake. It should allow the backend-* Pods only to:

Connect to db1-* Pods on port 1111

Connect to db2-* Pods on port 2222

Use the app Pod labels in your policy.

 

ℹ️ All Pods in the Namespace run plain Nginx images. This allows simple connectivity tests like: k -n project-snake exec POD_NAME -- curl POD_IP:PORT

 

ℹ️ For example, connections from backend-* Pods to vault-* Pods on port 3333 should no longer work

// 只允许从backend-* deployment的Pod访问db1-*和db2-* deployment的Pod的1111和2222端口，并且不允许backend-* deployment的Pod访问vault-* deployment的Pod的3333端口。





```yaml
# cka7968:/home/candidate/15_np.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-backend
  namespace: project-snake
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Egress                    # policy is only about Egress
  egress:
    -                           # first rule
      to:                           # first condition "to"
      - podSelector:
          matchLabels:
            app: db1
      ports:                        # second condition "port"
      - protocol: TCP
        port: 1111
    -                           # second rule
      to:                           # first condition "to"
      - podSelector:
          matchLabels:
            app: db2
      ports:                        # second condition "port"
      - protocol: TCP
        port: 2222

```



```bash



candidate@cka7968:~$ k -n project-snake get po -owide
NAME        READY   STATUS    RESTARTS   AGE     IP           NODE      NOMINATED NODE   READINESS GATES
backend-0   1/1     Running   0          3d19h   10.32.0.10   cka7968   <none>           <none>
db1-0       1/1     Running   0          3d19h   10.32.0.11   cka7968   <none>           <none>
db2-0       1/1     Running   0          3d19h   10.32.0.12   cka7968   <none>           <none>
vault-0     1/1     Running   0          3d19h   10.32.0.13   cka7968   <none>           <none>



candidate@cka7968:~$ k -n project-snake exec backend-0 -- curl -s 10.32.0.11:1111
database one
candidate@cka7968:~$ k -n project-snake exec backend-0 -- curl -s 10.32.0.12:2222
database two
candidate@cka7968:~$ 
candidate@cka7968:~$ 
candidate@cka7968:~$ 
candidate@cka7968:~$ 
candidate@cka7968:~$ k -n project-snake exec backend-0 -- curl -s 10.32.0.12:1111
# 超时未通
^C
candidate@cka7968:~$ k -n project-snake exec backend-0 -- curl -s 10.32.0.12:3333
^C # 超时未通
candidate@cka7968:~$ k -n project-snake exec backend-0 -- curl -s 10.32.0.11:2222
^C # 超时未通

```