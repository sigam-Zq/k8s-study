Solve this question on: ssh cka5774

Previously the application api-gateway used some external autoscaler which should now be replaced with a HorizontalPodAutoscaler (HPA). The application has been deployed to Namespaces api-gateway-staging and api-gateway-prod like this:

kubectl kustomize /opt/course/5/api-gateway/staging | kubectl apply -f -
kubectl kustomize /opt/course/5/api-gateway/prod | kubectl apply -f -
Using the Kustomize config at /opt/course/5/api-gateway do the following:

1. Remove the ConfigMap horizontal-scaling-config completely
2. Add HPA named api-gateway for the Deployment api-gateway with min 2 and max 4 replicas. It should scale at 50% average CPU utilisation
3. In prod the HPA should have max 6 replicas
4. Apply your changes for staging and prod so they're reflected in the cluster




```


➜ ssh cka5774

➜ candidate@cka5774:~$ cd /opt/course/5/api-gateway

➜ candidate@cka5774:/opt/course/5/api-gateway$ ls
base  prod  staging

➜ candidate@cka5774:/opt/course/5/api-gateway$ k kustomize base
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: NAMESPACE_REPLACE
---
apiVersion: v1
data:
  horizontal-scaling: "70"
kind: ConfigMap
metadata:
  name: horizontal-scaling-config
  namespace: NAMESPACE_REPLACE
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: NAMESPACE_REPLACE
spec:
  replicas: 1
  selector:
    matchLabels:
      id: api-gateway
  template:
    metadata:
      labels:
        id: api-gateway
    spec:
      containers:
      - image: httpd:2-alpine
        name: httpd
      serviceAccountName: api-gateway





candidate@cka5774:/opt/course/5/api-gateway$ k kustomize staging
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: api-gateway-staging
---
apiVersion: v1
data:
  horizontal-scaling: "60"
kind: ConfigMap
metadata:
  name: horizontal-scaling-config
  namespace: api-gateway-staging
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    env: staging
  name: api-gateway
  namespace: api-gateway-staging
spec:
  replicas: 1
  selector:
    matchLabels:
      id: api-gateway
  template:
    metadata:
      labels:
        id: api-gateway
    spec:
      containers:
      - image: httpd:2-alpine
        name: httpd
      serviceAccountName: api-gateway







candidate@cka5774:/opt/course/5/api-gateway$ k kustomize prod  | kubectl diff -f -
diff -u -N /tmp/LIVE-163143442/v1.ConfigMap.api-gateway-prod.horizontal-scaling-config /tmp/MERGED-555150113/v1.ConfigMap.api-gateway-prod.horizontal-scaling-config
--- /tmp/LIVE-163143442/v1.ConfigMap.api-gateway-prod.horizontal-scaling-config 2025-11-01 14:49:51.978109289 +0000
+++ /tmp/MERGED-555150113/v1.ConfigMap.api-gateway-prod.horizontal-scaling-config       2025-11-01 14:49:51.979109417 +0000
@@ -0,0 +1,10 @@
+apiVersion: v1
+data:
+  horizontal-scaling: "10"
+  loglevel: info
+kind: ConfigMap
+metadata:
+  creationTimestamp: "2025-11-01T14:49:51Z"
+  name: horizontal-scaling-config
+  namespace: api-gateway-prod
+  uid: 372c391d-925b-405c-91ea-1dfc14e063a6




candidate@cka5774:/opt/course/5/api-gateway$ k kustomize staging  | kubectl diff -f -
diff -u -N /tmp/LIVE-3714109537/v1.ConfigMap.api-gateway-staging.horizontal-scaling-config /tmp/MERGED-52938976/v1.ConfigMap.api-gateway-staging.horizontal-scaling-config
--- /tmp/LIVE-3714109537/v1.ConfigMap.api-gateway-staging.horizontal-scaling-config     2025-11-01 14:50:39.142128659 +0000
+++ /tmp/MERGED-52938976/v1.ConfigMap.api-gateway-staging.horizontal-scaling-config     2025-11-01 14:50:39.142128659 +0000
@@ -0,0 +1,9 @@
+apiVersion: v1
+data:
+  horizontal-scaling: "60"
+kind: ConfigMap
+metadata:
+  creationTimestamp: "2025-11-01T14:50:39Z"
+  name: horizontal-scaling-config
+  namespace: api-gateway-staging
+  uid: 4d3ef190-e20c-4f15-9aa4-d792ba6804bd


candidate@cka5774:/opt/course/5/api-gateway$ k kustomize staging  | kubectl apply -f -
serviceaccount/api-gateway unchanged
configmap/horizontal-scaling-config created
deployment.apps/api-gateway unchanged





candidate@cka5774:/opt/course/5/api-gateway$ k -n api-gateway-staging get deploy,cm
NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/api-gateway   1/1     1            1           3d21h

NAME                                  DATA   AGE
configmap/horizontal-scaling-config   1      52s
configmap/kube-root-ca.crt            1      3d21h

```

Step 1
We need to remove the ConfigMap from base, staging and prod because staging and prod both reference it as a patch. If we would only remove it from base we would run into an error when trying to build staging for example:



```
➜ candidate@cka5774:/opt/course/5/api-gateway$ k kustomize staging
error: no resource matches strategic merge patch "ConfigMap.v1.[noGrp]/horizontal-scaling-config.[noNs]": no matches for Id ConfigMap.v1.[noGrp]/horizontal-scaling-config.[noNs]; failed to find unique target for patch ConfigMap.v1.[noGrp]/horizontal-scaling-config.[noNs]
```

So we edit files base/api-gateway.yaml, staging/api-gateway.yaml and prod/api-gateway.yaml and remove the ConfigMap. Afterwards we should get no errors and Yaml without that ConfigMap:

```

➜ candidate@cka5774:/opt/course/5/api-gateway$ k kustomize staging
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: api-gateway-staging
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    env: staging
  name: api-gateway
  namespace: api-gateway-staging
spec:
  replicas: 1
  selector:
    matchLabels:
      id: api-gateway
  template:
    metadata:
      labels:
        id: api-gateway
    spec:
      containers:
      - image: httpd:2-alpine
        name: httpd
      serviceAccountName: api-gateway

➜ candidate@cka5774:/opt/course/5/api-gateway$ k kustomize prod
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
  namespace: api-gateway-prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    env: prod
  name: api-gateway
  namespace: api-gateway-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      id: api-gateway
  template:
    metadata:
      labels:
        id: api-gateway
    spec:
      containers:
      - image: httpd:2-alpine
        name: httpd
      serviceAccountName: api-gateway
```




Step 2
We're going to add the requested HPA into the base config file:

```

# cka5774:/opt/course/5/api-gateway/base/api-gateway.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway
  minReplicas: 2
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 50
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-gateway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      id: api-gateway
  template:
    metadata:
      labels:
        id: api-gateway
    spec:
      serviceAccountName: api-gateway
      containers:
        - image: httpd:2-alpine
          name: httpd
```


Notice that we don't specify a Namespace here as done also for the other resources. The Namespace will be set by staging and prod overlays automatically.


Step 3
In prod the HPA should have max replicas set to 6 so we add this to the prod patch:

....




